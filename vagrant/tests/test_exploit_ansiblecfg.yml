- name: test parameter passing with sudo in one go
  hosts: all
  gather_facts: no
  tasks:
    - name: Create /modules directory
      become: yes
      file: path=/etc/ansible state=directory

    - name: Drop /etc/ansible/ansible.cfg
      become: yes
      copy:
        content: |
          [defaults]
          library = /modules
        dest: /etc/ansible/ansible.cfg

    - name: Create /modules directory
      become: yes
      file: path=/modules state=directory

    - name: Drop stub module
      become: yes
      copy:
        content: |
          #!/bin/sh
          echo '{}'
        dest: /modules/custommodule.py

    - name: Drop fake ansible.cfg
      copy:
        content: |
          [defaults]
          library = /fooo
        dest: /home/vagrant/ansible.cfg

    - include: drop_script.yml
      vars:
        ignore_script_errors: yes
        playbook: |
          - hosts: all
            tasks:
              - action: custommodule
        script: |
          #!/bin/env python2.7

          import paternoster
          import paternoster.types

          s = paternoster.Paternoster(
            runner_parameters={'playbook': '/opt/uberspace/playbooks/uberspace-unittest.yml'},
            parameters=[],
            become_user='root',
            success_msg='executed successfully',
          ).auto()

    - name: Delete ansible.cfgs
      file: path={{ item }} state=absent
      become: yes
      with_items:
        - /home/vagrant/ansible.cfg
        - /etc/ansible/ansible.cfg

    - assert:
        that:
          - "script.stdout_lines[0] == 'executed successfully'"
